generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// ============================================================================
// AUTH & USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  emailVerified Boolean   @default(false)
  
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)
  
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  ownedOrgs     Organization[] @relation("OrganizationOwner")
  
  sessions      Session[]
  apiKeys       ApiKey[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@index([email])
  @@index([organizationId])
}

enum UserRole {
  ADMIN
  USER
  VIEWER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token     String   @unique
  expiresAt DateTime
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  key       String   @unique
  keyHash   String
  
  lastUsedAt DateTime?
  expiresAt  DateTime?
  
  rateLimit  Int      @default(1000) // requests per hour
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([key])
}

// ============================================================================
// ORGANIZATION & BILLING
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  
  ownerId   String
  owner     User     @relation("OrganizationOwner", fields: [ownerId], references: [id])
  members   User[]
  
  // Stripe
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  
  // Plan
  plan      BillingPlan  @default(FREE)
  status    OrgStatus    @default(TRIAL)
  
  // Usage limits
  monthlyLeadQuota   Int      @default(100)
  monthlyLeadsUsed   Int      @default(0)
  quotaResetDate     DateTime @default(now())
  
  // Settings
  settings  Json     @default("{}")
  
  leads     Lead[]
  queries   Query[]
  runs      Run[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([slug])
  @@index([ownerId])
}

enum BillingPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum OrgStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  SUSPENDED
}

// ============================================================================
// LEAD GENERATION (from original DEKES)
// ============================================================================

enum LeadStatus {
  REJECTED
  OUTREACH_READY
  REVIEW
  CONTACTED
  WON
  LOST
}

enum EntityType {
  PERSON
  COMPANY
}

enum EventType {
  CREATED
  UPDATED
  QUALIFIED
  REJECTED
  CONTACTED
  WON
  LOST
  TEMPLATE_SENT
  EXPORTED
}

enum TemplateType {
  DM
  FU
}

enum SourcePack {
  FORUMS
  SOCIAL
  PROFESSIONAL
  WIDE_WEB
}

model Query {
  id            String     @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name          String
  query         String
  sourcePack    SourcePack @default(WIDE_WEB)
  market        String     @default("en-US")
  freshness     String     @default("Week")
  enabled       Boolean    @default(true)

  ipsRewardSum   Float      @default(0)
  ipsWeightSum   Float      @default(0)

  runs          Run[]
  leads         Lead[]
  attempts      OutreachAttempt[]

  runsCount     Int        @default(0)
  leadsCount    Int        @default(0)
  qualifiedCount Int       @default(0)
  wonCount      Int        @default(0)
  lostCount     Int        @default(0)

  lastRunAt     DateTime?
  lastWinAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([enabled])
  @@index([organizationId])
}

model Run {
  id           String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  queryId      String
  query        Query     @relation(fields: [queryId], references: [id], onDelete: Cascade)

  startedAt    DateTime  @default(now())
  finishedAt   DateTime?

  resultCount  Int       @default(0)
  leadCount    Int       @default(0)
  qualifiedCount Int     @default(0)

  geoLocation  String?
  geoGl        String?
  geoHl        String?

  status       String    @default("STARTED")
  error        String?

  leads        Lead[]
  
  @@index([organizationId])
  @@index([queryId])
}

model Entity {
  id              String     @id @default(cuid())
  type            EntityType @default(PERSON)

  displayName     String?
  primaryEmail    String?
  primaryDomain   String?    @unique
  primaryHandle   String?

  handles         Json       @default("{}")
  domains         String[]   @default([])
  emails          String[]   @default([])

  leads           Lead[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([primaryEmail])
  @@index([primaryDomain])
}

model Lead {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  source            String
  sourceUrl         String
  canonicalUrl      String
  canonicalHash     String

  title             String?
  snippet           String?
  publishedAt       DateTime?

  score             Int
  intentDepth       Int
  urgencyVelocity   Int
  budgetSignals     Int
  fitPrecision      Int

  buyerType         String?
  painTags          String[]   @default([])
  serviceTags       String[]   @default([])

  rush12HourEligible Boolean   @default(false)

  intentClass       String?
  intentConfidence  Float?

  meta              Json       @default("{}")

  status            LeadStatus @default(OUTREACH_READY)
  rejectedReason    String?

  entityId          String?
  entity            Entity?    @relation(fields: [entityId], references: [id], onDelete: SetNull)

  queryId           String?
  query             Query?     @relation(fields: [queryId], references: [id], onDelete: SetNull)

  runId             String?
  run               Run?       @relation(fields: [runId], references: [id], onDelete: SetNull)

  events            LeadEvent[]
  attempts          OutreachAttempt[]

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@unique([organizationId, canonicalHash])
  @@index([score])
  @@index([status])
  @@index([entityId])
  @@index([queryId])
  @@index([organizationId])
}

model LeadEvent {
  id        String    @id @default(cuid())
  leadId    String
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  type      EventType
  meta      Json      @default("{}")

  createdAt DateTime  @default(now())

  @@index([leadId, type])
}

model CarbonReport {
  id        String   @id @default(cuid())

  queryId   String
  actualCO2 Float
  reportedAt DateTime @default(now())
  raw       Json     @default("{}")

  @@index([queryId])
  @@index([reportedAt])
}

model Template {
  id            String       @id @default(cuid())
  name          String
  type          TemplateType
  buyerType     String?
  serviceTag    String?
  painTag       String?

  body          String

  timesSent     Int          @default(0)
  repliesCount  Int          @default(0)
  wonCount      Int          @default(0)

  ipsRewardSum   Float        @default(0)
  ipsWeightSum   Float        @default(0)

  attempts       OutreachAttempt[]

  enabled       Boolean      @default(true)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([enabled])
}

model OutreachAttempt {
  id            String   @id @default(cuid())

  leadId        String
  lead          Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  queryId       String?
  query         Query?   @relation(fields: [queryId], references: [id], onDelete: SetNull)

  templateId    String?
  template      Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  queryProb     Float
  templateProb  Float
  overallProb   Float

  policy        String   @default("UCB1_SOFTMAX")
  policyVersion String   @default("v1")

  outcome       String?
  outcomeAt     DateTime?

  meta          Json     @default("{}")

  createdAt     DateTime @default(now())

  @@index([leadId])
  @@index([queryId])
  @@index([templateId])
}

model ScoringWeights {
  id              String   @id @default(cuid())

  intentWeight    Float    @default(1.0)
  urgencyWeight   Float    @default(1.0)
  budgetWeight    Float    @default(1.0)
  fitWeight       Float    @default(1.0)

  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())
}

model ConversionPattern {
  id             String   @id @default(cuid())
  key            String   @unique

  wins           Int      @default(0)
  losses         Int      @default(0)

  lastWinAt      DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
